<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#16a34a">
    <link rel="manifest" href="../manifest.json">
    <title>Daily Drilling Report</title>

    <!-- Resource Hints for Performance -->
    <link rel="dns-prefetch" href="https://unpkg.com">
    <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    <link rel="dns-prefetch" href="https://apis.google.com">
    <link rel="dns-prefetch" href="https://accounts.google.com">
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://apis.google.com">

    <!-- External Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Tailwind Configuration -->
    <script src="tailwind-config.js"></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="root">
        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif; flex-direction: column;">
            <div style="font-size: 24px; margin-bottom: 10px;">Loading...</div>
            <div style="font-size: 14px; color: #666;">Please wait while the application loads</div>
        </div>
    </div>

    <!-- Shared Modules Loader -->
    <script src="../shared/loader.js?v=1.3-mobile-fix"></script>

    <!-- Main Application - Load after modules are ready -->
    <script>
        // Wait for shared modules before loading main app
        window.addEventListener('sharedModulesLoaded', async () => {
            console.log('sharedModulesLoaded event received, fetching app.js...');

            // Update loading message
            const rootEl = document.getElementById('root');
            if (rootEl) {
                rootEl.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif; flex-direction: column;"><div style="font-size: 24px; margin-bottom: 10px;">Loading Application...</div><div style="font-size: 14px; color: #666;">Please wait, this may take a moment on mobile devices</div></div>';
            }

            try {
                // Fetch the script content (service worker handles caching)
                const response = await fetch('app.js');
                const code = await response.text();
                console.log('app.js fetched, creating inline script...');

                // Create inline script with the code
                const script = document.createElement('script');
                script.type = 'text/babel';
                script.setAttribute('data-presets', 'react');
                script.textContent = code;
                document.body.appendChild(script);

                console.log('Script appended, waiting for browser idle time...');

                // Use requestIdleCallback for better Safari/Brave compatibility
                const transformBabel = () => {
                    try {
                        if (window.Babel && window.Babel.transformScriptTags) {
                            console.log('Triggering Babel transformation...');
                            window.Babel.transformScriptTags();
                            console.log('Babel transformation complete');
                        } else {
                            throw new Error('Babel not loaded');
                        }
                    } catch (error) {
                        console.error('Babel transformation error:', error);
                        throw error;
                    }
                };

                // Use requestIdleCallback for Safari/Brave, or setTimeout as fallback
                if (window.requestIdleCallback) {
                    requestIdleCallback(transformBabel, { timeout: 3000 });
                } else {
                    setTimeout(transformBabel, 200);
                }
            } catch (error) {
                console.error('Failed to load app.js:', error);
                if (rootEl) {
                    rootEl.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif; flex-direction: column; padding: 20px; text-align: center;"><div style="font-size: 24px; margin-bottom: 10px; color: #dc2626;">Error Loading App</div><div style="font-size: 14px; color: #666; margin-bottom: 20px;">Failed to load the application. Please try:</div><div style="font-size: 14px; color: #666;">1. Refresh the page (pull down or F5)</div><div style="font-size: 14px; color: #666;">2. Clear browser cache</div><div style="font-size: 14px; color: #666;">3. Check your internet connection</div></div>';
                }
            }
        });
    </script>

    <!-- Service Worker Registration -->
    <script>
        // Register service worker for offline capability
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('../service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registered successfully:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
